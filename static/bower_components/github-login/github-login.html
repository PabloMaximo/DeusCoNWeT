<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">

<polymer-element name="github-login" attributes="client_id scope">
  <!-- Lo primero es el template -->
  <template>
    <style>
    </style>
    <core-ajax
               id="githubcode" url="http://github-login-lab.appspot.com/oauth/github"
               method="GET"
               params='{
                       "action": "request_token",
                       "code": "{{code}}"
                       }'
               handleAs="json"
               on-core-response='{{response}}'
               >
    </core-ajax>

    <paper-button id="loginGithub" on-click="{{login}}">
      Sign in with GitHub
    </paper-button>

  </template>
  <!-- Después va el script, en JS, que añade la lógica -->
  <script>
    Polymer({
      accessToken: '',
      code:'',
      scope:'',
      response: function(e, d, s){
          this.accessToken = s.response;
          this.fire('github-logged',{token:this.accessToken});
      },
      login: function(event, detail, sender){
        // Generamos la direccion donde vamos a realizar la peticion
        var url = 'https://github.com/login/oauth/authorize?';
        url += 'scope='+this.scope;
        url+='&client_id='+this.client_id;
        url+='&redirect_uri='+'http://github-login-lab.appspot.com/app/demo.html';
        // Guardamos en una variable el scope de la ventana principal
        var back = this;
        // Abrimos la ventana para que se realice la autenticacion
        var win = window.open(url, "Autentícate", 'width=800, height=600');
        // Escuchamos la direccion hasta que cambia con el codigo
        // NOTA: el callback y la ventana actual deben tener el mismo:
        // dominio,puerto y protocolo
        var pollTimer = window.setInterval(function() {
          try {
            // Esperamos a que nos devuelan un token
            if (win.document.URL.indexOf('code') != -1) {
              // Eliminamos el timer
              window.clearInterval(pollTimer);
              // Sacamos el codigo mediante expresion regular
              var url =   win.document.URL;
							var patron = "code"+"=([^&#]*)";
							var exp = new RegExp(patron);
              // Ponemos en valor en una variable de la ventana principal
							back.code = exp.exec(url)[1];
              // Llamamos a backend para que obtenga el token
              back.$.githubcode.go();
              win.close();
            }
          } catch (e) {

          }
        }, 100);
      },
    });
  </script>
</polymer-element>
